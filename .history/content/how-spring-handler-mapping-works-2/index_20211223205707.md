---
emoji: ğŸ““
title: Spring MVC - HandlerMappingì˜ ë™ì‘ë°©ì‹ ì´í•´í•˜ê¸° 2í¸
date: '2021-06-9 00:00:00'
author: weasel
tags: Spring handlerMapping
categories: Spring
---
![](./image.png)

### MappingRegistry
`MappingRegistry`ëŠ” ì•„ê¹Œ ì‚´í´ë³¸ `AbstractHandlerMethodMapping`ì˜ ë‚´ë¶€ í´ë˜ìŠ¤ë‹¤. `MappingRegistry`ëŠ” **handler methodì— ëŒ€í•œ ëª¨ë“  mappingì„ ìœ ì§€ ê´€ë¦¬**í•˜ê³  **`lookup`ì„ ìˆ˜í–‰í•˜ëŠ” method**ë¥¼ ê°€ì§€ê³  ìˆê³  ë™ì‹œì„±ì„ ê°€ì§„ ì ‘ê·¼ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ë‹¤.
>A registry that maintains all mappings to handler methods, exposing methods to perform lookups and providing concurrent access.
Package-private for testing purposes.

ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì´ **handler methodì— ëŒ€í•œ ëª¨ë“  mappingì„ ìœ ì§€ ê´€ë¦¬**í•˜ê³  **`lookup`ì„ ìˆ˜í–‰í•˜ëŠ” method**ë¥¼ ê°€ì§€ê³  ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

```java
class MappingRegistry {
  private final Map<T, MappingRegistration<T>> registry = new HashMap<>();

  private final Map<T, HandlerMethod> mappingLookup = new LinkedHashMap<>();

  private final MultiValueMap<String, T> urlLookup = new LinkedMultiValueMap<>();

  private final Map<String, List<HandlerMethod>> nameLookup = new ConcurrentHashMap<>();

  private final Map<HandlerMethod, CorsConfiguration> corsLookup = new ConcurrentHashMap<>();

  private final ReentrantReadWriteLock readWriteLock = new ReentrantReadWriteLock();
  ...
  ...
  
  // methods
}
```
`MappingRegistry` ì•ˆì—ì„œ `Map` ìë£Œêµ¬ì¡°ë¥¼ ê°€ì§„ ë©¤ë²„ ë³€ìˆ˜ë“¤ì´ ìˆë‹¤. ê·¸ ì¤‘ì—ì„œ`LinkedMultiValueMap`ì´ë¼ëŠ” ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ê±´ í•œê°œì˜ keyì— ì—¬ëŸ¬ valueë“¤ì„ ì €ì¥í•˜ëŠ” `MultiValueMap`ì„ `LinkedHashMap`ìœ¼ë¡œ ê°ì‹¼ ìë£Œêµ¬ì¡°ë¡œ Springì´ ë§Œë“  ìë£Œêµ¬ì¡°ë‹¤.

`urlLookup`ì€ `LinkedMultiValueMap`ì˜ ìë£Œêµ¬ì¡°ì¸ë°, keyëŠ” `url`ì„ ê°€ì§€ê³ , valueëŠ” `RequestMappingInfo`ë¥¼ ê°€ì§„ë‹¤. `LinkedMultiValueMap`ì„ ì“°ëŠ” ì´ìœ ëŠ” í•˜ë‚˜ì˜ `url`ì— ì—¬ëŸ¬ handlerMethodë“¤ì— ëŒ€í•œ ì •ë³´ê°€ ë‹´ê¸°ê¸° ë•Œë¬¸ì´ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ `"/app/user"`ë¼ëŠ” `url` ì•„ë˜ userì— ëŒ€í•œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” `GET`,userë¥¼ ì¶”ê°€í•˜ëŠ” `POST`ê°€ ë§¤í•‘ë ë•Œ, ì•„ë˜ì²˜ëŸ¼ `RequestMappingInfo`ê°€ ë“¤ì–´ê°€ëŠ” ê²ƒì´ë‹¤.
```javascript
key : "/app/user/ 
value : [GET /app/user,POST /app/user]
```

ìœ„ì™€ ê°™ì€ êµ¬ì¡°ë¥¼ í†µí•´ `MappingRegistry`ëŠ” `url`ì— í•´ë‹¹í•˜ëŠ” handlerMethodë¥¼ êµ¬ë³„í•  ìˆ˜ ìˆê²Œ ëœë‹¤. ì½”ë“œë¡œ ë³´ì.

```java
protected HandlerMethod lookupHandlerMethod(String lookupPath, HttpServletRequest request) throws Exception {
  List<Match> matches = new ArrayList<>();
  List<T> directPathMatches = this.mappingRegistry.getMappingsByUrl(lookupPath);
  if (directPathMatches != null) {
    addMatchingMappings(directPathMatches, matches, request);
  }
  ...
  ...
  if (!matches.isEmpty()) {
    ...
    ...
    matches.sort(comparator);
    Match bestMatch = matches.get(0);
    ...
    ...
    request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);
    handleMatch(bestMatch.mapping, lookupPath, request);
    return bestMatch.handlerMethod;
  }

```
ìœ„ëŠ” ì•„ê¹Œ ì ê¹ ì–¸ê¸‰í•œ `lookupHandlerMethod`ì´ë‹¤. _**ì ì ˆí•œ `handlerMethod`ë¥¼ ê°€ì ¸ì˜¨ í›„ return í•œë‹¤**_ ê³  í–ˆëŠ”ë° ê·¸ ê³¼ì •ì´ ë‹´ê²¨ìˆë‹¤. 
ê¸¸ë‹¤ê³  ê²ë¨¹ì§€ ë§ê³  í•œì¤„ì”© ë³´ì. (_matchë˜ëŠ” ê²ƒì´ ì—†ê±°ë‚˜, 2ê°œ ì´ìƒì¸ ê²½ìš°ëŠ” ì œì™¸í•¨_)

```java
List<Match> matches = new ArrayList<>();
```
`match`ë¥¼ ë‹´ëŠ” `matches`ë¼ëŠ” ë¦¬ìŠ¤íŠ¸ê°€ ìˆë‹¤.
```java 
List<T> directPathMatches = this.mappingRegistry.getMappingsByUrl(lookupPath);

```
í˜„ì¬ `url`ì— mappingë˜ëŠ” handler methodë“¤ì˜ `RequestMappingInfo`ë“¤ì„ `getMappingsByUrl`ë¡œ ê°€ì ¸ì˜¨ í›„ `directPathMatches`ì— ì €ì¥í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `url`ì´ `/app/user`ì´ë©´ `directPathMatches`ì—ëŠ” `[GET /app/user, POST /app/user]` ì™€ ê°™ì€ ì •ë³´ê°€ ë“¤ì–´ì˜¤ëŠ” ê²ƒì´ë‹¤.

```java
if (directPathMatches != null) {
    addMatchingMappings(directPathMatches, matches, request);
}
```
ê·¸ í›„ `[GET /app/user, POST /app/user]` ì¤‘ì—ì„œ request ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤ì„ `addMatchingMappings`ì„ í†µí•´ì„œ `matches`ì— ì¶”ê°€í•œë‹¤.

```java
matches.sort(comparator);
Match bestMatch = matches.get(0);
```
`matches`ë“¤ì„ ìš°ì„ ìˆœìœ„ì— ë§ê²Œë” ì •ë ¬í•˜ê³ , requestì™€ ê°€ì¥ ì¼ì¹˜í•˜ëŠ” 0ë²ˆì§¸ `match`ë¥¼ `bestMatch`ì— ì €ì¥í•œë‹¤.

```java
request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);
handleMatch(bestMatch.mapping, lookupPath, request);
return bestMatch.handlerMethod;
```
`bestMatch`ì˜ ë©¤ë²„ì¸ `handlerMethod`ë¥¼ returní•´ì„œ ìµœì¢…ì ìœ¼ë¡œ ì í•©í•œ handler methodë¥¼ ì°¾ê²Œ ëœë‹¤.

```java
private class Match {

  private final T mapping;

  private final HandlerMethod handlerMethod;

}
```
### Reflection
ì´ì œ ë§ˆì§€ë§‰ ê¶ê¸ˆì¦ë§Œì´ ë‚¨ì•˜ë‹¤.

### ì¶œì²˜ 
[MappingReigstry javadoc](https://docs.spring.io/spring-framework/docs/4.3.2.RELEASE_to_4.3.3.RELEASE/Spring%20Framework%204.3.3.RELEASE/org/springframework/web/servlet/handler/AbstractHandlerMethodMapping.MappingRegistry.html)
[LinkedMultiValueMap javadoc](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/util/LinkedMultiValueMap.html)

```toc

```
